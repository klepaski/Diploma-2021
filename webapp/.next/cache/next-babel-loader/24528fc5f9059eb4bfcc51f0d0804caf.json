{"ast":null,"code":"import _Object$defineProperty from \"@babel/runtime-corejs2/core-js/object/define-property\";\nimport _Object$defineProperties from \"@babel/runtime-corejs2/core-js/object/define-properties\";\nimport _Object$getOwnPropertyDescriptors from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptors\";\nimport _Object$getOwnPropertyDescriptor from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptor\";\nimport _Object$getOwnPropertySymbols from \"@babel/runtime-corejs2/core-js/object/get-own-property-symbols\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport _objectDestructuringEmpty from \"@babel/runtime-corejs2/helpers/esm/objectDestructuringEmpty\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = _Object$keys(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useState, useContext, useEffect } from 'react';\nimport Router, { useRouter } from 'next/router';\nimport { Wrapper, WrapperHeight } from \"../../../components/StyledComponents/Wrapper\";\nimport { Footer } from \"../../../components/Layouts/styledLayouts\";\nimport { Button } from \"../../../components/controls/Button/Button\";\nimport Upload from '../../../components/Offer/photos/Upload';\nimport Photos from '../../../components/Offer/photos/Photos';\nimport EditPhoto from '../../../components/Photo/EditPhoto';\nimport CoverPhoto from '../../../components/Offer/photos/CoverPhoto';\nimport Video from '../../../components/Offer/photos/Video';\nimport Header from \"../../../components/Header/Header\";\nimport { apiEditOffer, apiOfferPhotos, apiSetOfferCoverPhoto, apiRemoveOfferPhoto, apiEditOfferPhoto } from '../../../actions/api';\nimport withOfferInfo from \"../../../utils/offer\";\nimport { showNotification } from \"../../../utils/notification\";\nimport useOffer from \"../../../hooks/useOffer\";\nimport '../../../components/Offer/photos/photo.css';\nimport { MainContext } from \"../../../components/contextProviders/MainContext\";\nimport { ContainerDesktop, FooterDesktop } from \"../../../components/StyledComponents/Grid\";\nimport styled from \"styled-components\";\nimport { device } from \"../../../lib/mediaDevice\";\n\nvar PhotosPage = function PhotosPage(_ref) {\n  _objectDestructuringEmpty(_ref);\n\n  var router = useRouter();\n  var id = router.query.id;\n  var offer = useOffer(id);\n\n  var _useContext = useContext(MainContext),\n      setOffer = _useContext.setOffer;\n\n  var _useState = useState(0),\n      step = _useState[0],\n      setStep = _useState[1];\n\n  var _useState2 = useState(false),\n      loading = _useState2[0],\n      setLoading = _useState2[1];\n\n  var _useState3 = useState(false),\n      loadingEdit = _useState3[0],\n      setLoadingEdit = _useState3[1];\n\n  var _useState4 = useState(false),\n      uploading = _useState4[0],\n      setUploading = _useState4[1];\n\n  var _useState5 = useState([]),\n      photos = _useState5[0],\n      setPhotos = _useState5[1];\n\n  var _useState6 = useState(['']),\n      videos = _useState6[0],\n      _setVideos = _useState6[1];\n\n  var _useState7 = useState(null),\n      cover = _useState7[0],\n      setCover = _useState7[1];\n\n  var _useState8 = useState({}),\n      photoEditable = _useState8[0],\n      setPhotoEditable = _useState8[1];\n\n  var _useState9 = useState(null),\n      keyPhoto = _useState9[0],\n      setKeyPhoto = _useState9[1];\n\n  useEffect(function () {\n    if (offer.videoUrl && offer.videoUrl.length) {\n      _setVideos(offer.videoUrl);\n    }\n\n    if (offer.offerPhoto && offer.offerPhoto.length) {\n      setPhotos(offer.offerPhoto);\n      setAvatarId();\n      setStep(2);\n    } else {\n      setStep(1);\n    }\n  }, [offer.id]);\n\n  var setAvatarId = function setAvatarId() {\n    if (!offer.avatarUrl) {\n      setCover(offer.offerPhoto[0].id);\n    } else {\n      var avatar = offer.offerPhoto.find(function (item) {\n        return item.photoUrl === offer.avatarUrl;\n      });\n\n      if (avatar && avatar.id) {\n        setCover(avatar.id);\n      }\n    }\n  };\n\n  var onDrop = function onDrop(files) {\n    // setPhotos([...photos, ...files])\n    // setStep(2)\n    onUploadFiles(files);\n  };\n\n  var onUploadFiles = function onUploadFiles(files) {\n    var data, res;\n    return _regeneratorRuntime.async(function onUploadFiles$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            data = new FormData();\n            data.append(\"offerId\", id);\n            files.forEach(function (file) {\n              if (!file.id || file.blob) {\n                if (file.blob) {\n                  data.append(\"file\", file.blob, file.name);\n                } else {\n                  data.append(\"file\", file, file.name);\n                }\n              }\n            });\n            setUploading(true);\n            _context.next = 6;\n            return _regeneratorRuntime.awrap(apiOfferPhotos(data));\n\n          case 6:\n            res = _context.sent;\n\n            if (res.data) {\n              setPhotos([].concat(_toConsumableArray(photos), _toConsumableArray(res.data)));\n              if (res.data[0]) setCover(res.data[0].id);\n            }\n\n            setUploading(false);\n            setStep(2);\n\n          case 10:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    });\n  };\n\n  var onSetCover = function onSetCover(id) {\n    setCover(id);\n    setStep(2);\n  };\n\n  var handleChangeStep = function handleChangeStep(i) {\n    if (step === 5 && i === -1) {\n      setStep(2);\n      return;\n    }\n\n    if ((step === 1 || step === 2) && i === -1) {\n      Router.push('/offers/[id]/params', \"/offers/\".concat(id, \"/params\"), {\n        shallow: true\n      });\n    } else {\n      setStep(step + i);\n    }\n  };\n\n  var handleSave = function handleSave() {\n    var data, filterV, res;\n    return _regeneratorRuntime.async(function handleSave$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (step == 1) {\n              apiEditOffer(id, {\n                step: 2\n              });\n              Router.push('/offers/[id]/regulations', \"/offers/\".concat(id, \"/regulations\"), {\n                shallow: true\n              });\n            }\n\n            if (!(step == 2)) {\n              _context2.next = 8;\n              break;\n            }\n\n            data = new FormData();\n            data.append(\"offerId\", id);\n            photos.forEach(function (file) {\n              if (!file.id || file.blob) {\n                if (file.blob) {\n                  data.append(\"file\", file.blob, file.name);\n                } else {\n                  data.append(\"file\", file, file.name);\n                }\n              }\n            });\n            handleSendPhotos(data); // let photosDeleting = photos.filter((item, key) => (item.blob && item.id))\n            // if(photosDeleting.length) {\n            //     Promise.all(photosDeleting.map(item => handleRemovePhoto(item.id)))\n            //         .then(res => {\n            //             handleSendPhotos(data)\n            //         })\n            // } else {\n            //     handleSendPhotos(data)\n            // }\n\n            _context2.next = 15;\n            break;\n\n          case 8:\n            if (!(step == 5)) {\n              _context2.next = 15;\n              break;\n            }\n\n            filterV = videos.filter(function (item) {\n              return !!item;\n            });\n            _context2.next = 12;\n            return _regeneratorRuntime.awrap(apiEditOffer(id, {\n              step: 2,\n              videoUrl: filterV\n            }));\n\n          case 12:\n            res = _context2.sent;\n            setOffer(_objectSpread({}, offer, {\n              videoUrl: res.data.videoUrl\n            }));\n            Router.push('/offers/[id]/regulations', \"/offers/\".concat(id, \"/regulations\"), {\n              shallow: true\n            });\n\n          case 15:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    });\n  };\n\n  var handleSendPhotos = function handleSendPhotos(data) {\n    //TODO optimaze and don't send if something not changed\n    setLoading(true);\n    apiSetOfferCoverPhoto(id, {\n      offerPhotoId: cover\n    }).then(function (res) {\n      debugger;\n      setOffer(_objectSpread({}, offer, {\n        avatarUrl: res.data.avatarUrl\n      }));\n    });\n    var photosWithDesc = photos.filter(function (item) {\n      return item.description;\n    });\n\n    _Promise.all(photosWithDesc.map(function (item) {\n      return handleEditPhoto(item);\n    })).then(function (res) {\n      console.log('res', res);\n    });\n\n    apiOfferPhotos(data).then(function (res) {\n      setLoading(false);\n      var photosFilter = photos.filter(function (item) {\n        return item.id && !item.blob;\n      });\n      setPhotos([].concat(_toConsumableArray(photosFilter), _toConsumableArray(res.data)));\n      setOffer(_objectSpread({}, offer, {\n        offerPhoto: [].concat(_toConsumableArray(photosFilter), _toConsumableArray(res.data))\n      }));\n      setStep(5);\n    })[\"catch\"](function (e) {\n      showNotification('error', e);\n      setLoading(false);\n    });\n  };\n\n  var handleEditPhoto = function handleEditPhoto(photo) {\n    var res;\n    return _regeneratorRuntime.async(function handleEditPhoto$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            _context3.next = 2;\n            return _regeneratorRuntime.awrap(apiEditOfferPhoto(photo));\n\n          case 2:\n            res = _context3.sent;\n            console.log(res);\n            return _context3.abrupt(\"return\", res);\n\n          case 5:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    });\n  };\n\n  var handleRemovePhoto = function handleRemovePhoto(id) {\n    var res;\n    return _regeneratorRuntime.async(function handleRemovePhoto$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            _context4.next = 2;\n            return _regeneratorRuntime.awrap(apiRemoveOfferPhoto(id));\n\n          case 2:\n            res = _context4.sent;\n            console.log(res);\n            return _context4.abrupt(\"return\", res);\n\n          case 5:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    });\n  };\n\n  var handleDeletePhoto = function handleDeletePhoto(key) {\n    var photoByKey, res, photosClone, _photosClone;\n\n    return _regeneratorRuntime.async(function handleDeletePhoto$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            photoByKey = photos[key];\n\n            if (!photoByKey.id) {\n              _context5.next = 11;\n              break;\n            }\n\n            _context5.next = 4;\n            return _regeneratorRuntime.awrap(handleRemovePhoto(photoByKey.id));\n\n          case 4:\n            res = _context5.sent;\n            photosClone = _toConsumableArray(photos);\n            photosClone.splice(key, 1);\n            setPhotos(photosClone);\n            setStep(2);\n            _context5.next = 15;\n            break;\n\n          case 11:\n            _photosClone = _toConsumableArray(photos);\n\n            _photosClone.splice(key, 1);\n\n            setPhotos(_photosClone);\n            setStep(2);\n\n          case 15:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    });\n  };\n\n  var setEditablePhoto = function setEditablePhoto(photo, key) {\n    setPhotoEditable(photo);\n    setKeyPhoto(key);\n    setStep(4);\n  };\n\n  var handleBackFromEdit = function handleBackFromEdit() {\n    setPhotoEditable({});\n    setKeyPhoto(null);\n    setStep(2);\n  };\n\n  var handleRotate = function handleRotate(blob, url, key) {\n    var photosCopy, ephoto, isCover, data, res;\n    return _regeneratorRuntime.async(function handleRotate$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            _context6.prev = 0;\n            photosCopy = _toConsumableArray(photos), ephoto = photosCopy[key], isCover = !!(cover == ephoto.id);\n            setLoadingEdit(true);\n            data = new FormData();\n            data.append(\"offerId\", offer.id);\n            data.append(\"file\", blob, 'blob file');\n            _context6.next = 8;\n            return _regeneratorRuntime.awrap(apiOfferPhotos(data));\n\n          case 8:\n            res = _context6.sent;\n\n            if (!(ephoto && ephoto.id)) {\n              _context6.next = 12;\n              break;\n            }\n\n            _context6.next = 12;\n            return _regeneratorRuntime.awrap(handleRemovePhoto(ephoto.id));\n\n          case 12:\n            if (isCover) {\n              setCover(res.data[0].id);\n            }\n\n            photosCopy[key] = res.data[0];\n            setPhotos(photosCopy);\n            setLoadingEdit(false);\n            setStep(2);\n            _context6.next = 23;\n            break;\n\n          case 19:\n            _context6.prev = 19;\n            _context6.t0 = _context6[\"catch\"](0);\n            showNotification('error', _context6.t0);\n            setLoadingEdit(false);\n\n          case 23:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, null, null, [[0, 19]]);\n  };\n\n  var onChangePhotoDescription = function onChangePhotoDescription(id, value) {\n    value = value.slice(0, 100);\n\n    var photosClone = _toConsumableArray(photos);\n\n    var key = photosClone.findIndex(function (item) {\n      return item.id === id;\n    });\n    photosClone[key].description = value;\n    setPhotos(photosClone);\n    console.log(key, value);\n  };\n\n  var disabled = loading;\n  return __jsx(React.Fragment, null, __jsx(Header, {\n    isReg: true\n  }), __jsx(Wrapper, {\n    p: 17,\n    pt: 35\n  }, offer.id ? __jsx(React.Fragment, null, __jsx(ContainerDesktop, {\n    isOffer: true\n  }, __jsx(WrapperHeight, null, uploading && __jsx(\"div\", {\n    className: \"photo-uploading-router\"\n  }, \" Uploading... \"), step === 1 && __jsx(Upload, {\n    onDrop: onDrop\n  }), step === 2 && __jsx(Photos, {\n    onDrop: onDrop,\n    setStep: setStep,\n    cover: cover,\n    photos: photos,\n    setEditablePhoto: setEditablePhoto,\n    isHiddenDeleting: true\n  }), step === 3 && __jsx(CoverPhoto, {\n    photos: photos,\n    setCover: onSetCover,\n    handleBack: handleBackFromEdit,\n    cover: cover\n  }), step === 4 && __jsx(EditPhoto, {\n    keyPhoto: keyPhoto,\n    photo: photoEditable,\n    handleBack: handleBackFromEdit,\n    handleRotate: handleRotate,\n    handleDelete: handleDeletePhoto,\n    onChangePhotoDescription: onChangePhotoDescription,\n    loadingEdit: loadingEdit\n  }), step === 5 && __jsx(Video, {\n    videos: videos,\n    setVideos: function setVideos(videos) {\n      return _setVideos(_toConsumableArray(videos));\n    }\n  }))), step !== 3 && step !== 4 && __jsx(FooterDesktop, null, __jsx(Footer, {\n    pt: 30\n  }, __jsx(Button, {\n    onClick: function onClick() {\n      return handleChangeStep(-1);\n    }\n  }, \"Back\"), __jsx(Button, {\n    blue: true,\n    onClick: function onClick() {\n      return handleSave();\n    },\n    loading: loading\n  }, step === 1 ? 'Skip' : 'Next')))) : __jsx(React.Fragment, null, \"Loading...\")));\n};\n\nexport default PhotosPage;","map":{"version":3,"sources":["D:/4/диплом/webapp — копия/pages/offers/[id]/photos.js"],"names":["React","useState","useContext","useEffect","Router","useRouter","Wrapper","WrapperHeight","Footer","Button","Upload","Photos","EditPhoto","CoverPhoto","Video","Header","apiEditOffer","apiOfferPhotos","apiSetOfferCoverPhoto","apiRemoveOfferPhoto","apiEditOfferPhoto","withOfferInfo","showNotification","useOffer","MainContext","ContainerDesktop","FooterDesktop","styled","device","PhotosPage","router","id","query","offer","setOffer","step","setStep","loading","setLoading","loadingEdit","setLoadingEdit","uploading","setUploading","photos","setPhotos","videos","setVideos","cover","setCover","photoEditable","setPhotoEditable","keyPhoto","setKeyPhoto","videoUrl","length","offerPhoto","setAvatarId","avatarUrl","avatar","find","item","photoUrl","onDrop","files","onUploadFiles","data","FormData","append","forEach","file","blob","name","res","onSetCover","handleChangeStep","i","push","shallow","handleSave","handleSendPhotos","filterV","filter","offerPhotoId","then","photosWithDesc","description","all","map","handleEditPhoto","console","log","photosFilter","e","photo","handleRemovePhoto","handleDeletePhoto","key","photoByKey","photosClone","splice","setEditablePhoto","handleBackFromEdit","handleRotate","url","photosCopy","ephoto","isCover","onChangePhotoDescription","value","slice","findIndex","disabled"],"mappings":"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","sourcesContent":["import React, { useState, useContext, useEffect } from 'react';\r\nimport Router, { useRouter } from 'next/router'\r\n\r\nimport {Wrapper, WrapperHeight} from \"../../../components/StyledComponents/Wrapper\";\r\nimport {Footer} from \"../../../components/Layouts/styledLayouts\";\r\nimport {Button} from \"../../../components/controls/Button/Button\";\r\nimport Upload from '../../../components/Offer/photos/Upload'\r\nimport Photos from '../../../components/Offer/photos/Photos'\r\nimport EditPhoto from '../../../components/Photo/EditPhoto'\r\nimport CoverPhoto from '../../../components/Offer/photos/CoverPhoto'\r\nimport Video from '../../../components/Offer/photos/Video'\r\nimport Header from \"../../../components/Header/Header\";\r\n\r\nimport {apiEditOffer, apiOfferPhotos, apiSetOfferCoverPhoto, apiRemoveOfferPhoto, apiEditOfferPhoto} from '../../../actions/api'\r\nimport withOfferInfo from \"../../../utils/offer\";\r\nimport {showNotification} from \"../../../utils/notification\";\r\nimport useOffer from \"../../../hooks/useOffer\"\r\n\r\nimport '../../../components/Offer/photos/photo.css'\r\nimport {MainContext} from \"../../../components/contextProviders/MainContext\";\r\nimport {ContainerDesktop, FooterDesktop} from \"../../../components/StyledComponents/Grid\";\r\nimport styled from \"styled-components\";\r\nimport {device} from \"../../../lib/mediaDevice\";\r\n\r\nconst PhotosPage = ({}) => {\r\n    const router = useRouter()\r\n    const {id} = router.query\r\n    const offer = useOffer(id)\r\n    const {setOffer} = useContext(MainContext)\r\n    const [step, setStep] = useState(0)\r\n    const [loading, setLoading] = useState(false)\r\n    const [loadingEdit, setLoadingEdit] = useState(false)\r\n    const [uploading, setUploading] = useState(false)\r\n    const [photos, setPhotos] = useState([])\r\n    const [videos, setVideos] = useState([''])\r\n    const [cover, setCover] = useState(null)\r\n    const [photoEditable, setPhotoEditable] = useState({})\r\n    const [keyPhoto, setKeyPhoto] = useState(null)\r\n\r\n    useEffect(() => {\r\n        if(offer.videoUrl && offer.videoUrl.length) {\r\n            setVideos(offer.videoUrl)\r\n        }\r\n        if(offer.offerPhoto && offer.offerPhoto.length) {\r\n            setPhotos(offer.offerPhoto)\r\n            setAvatarId()\r\n            setStep(2)\r\n        } else {\r\n            setStep(1)\r\n        }\r\n    }, [offer.id])\r\n\r\n    const setAvatarId = () => {\r\n        if(!offer.avatarUrl) {\r\n            setCover(offer.offerPhoto[0].id)\r\n        } else {\r\n            let avatar = offer.offerPhoto.find(item => item.photoUrl === offer.avatarUrl)\r\n            if(avatar && avatar.id) {\r\n                setCover(avatar.id)\r\n            }\r\n        }\r\n    }\r\n\r\n    const onDrop = (files) => {\r\n        // setPhotos([...photos, ...files])\r\n        // setStep(2)\r\n        onUploadFiles(files)\r\n    }\r\n    const onUploadFiles = async (files) => {\r\n        let data = new FormData();\r\n        data.append(\"offerId\", id);\r\n        files.forEach(file => {\r\n            if(!file.id || file.blob) {\r\n                if(file.blob) {\r\n                    data.append(\"file\", file.blob, file.name)\r\n                } else {\r\n                    data.append(\"file\", file, file.name)\r\n                }\r\n            }\r\n        });\r\n        setUploading(true)\r\n        let res = await apiOfferPhotos(data)\r\n        if(res.data) {\r\n            setPhotos([...photos, ...res.data])\r\n            if(res.data[0]) setCover(res.data[0].id)\r\n        }\r\n        setUploading(false)\r\n        setStep(2)\r\n    }\r\n    const onSetCover = id => {\r\n        setCover(id)\r\n        setStep(2)\r\n    }\r\n    const handleChangeStep = i => {\r\n        if(step === 5 && i === -1) {\r\n            setStep(2)\r\n            return\r\n        }\r\n        if((step === 1 || step === 2 ) && i === -1) {\r\n            Router.push('/offers/[id]/params', `/offers/${id}/params`, {shallow: true})\r\n        } else {\r\n            setStep(step + i)\r\n        }\r\n    }\r\n    const handleSave = async () => {\r\n        if(step == 1) {\r\n            apiEditOffer(id, {step: 2})\r\n            Router.push('/offers/[id]/regulations', `/offers/${id}/regulations`, {shallow: true})\r\n        }\r\n        if(step == 2) {\r\n            let data = new FormData();\r\n            data.append(\"offerId\", id);\r\n            photos.forEach(file => {\r\n                if(!file.id || file.blob) {\r\n                    if(file.blob) {\r\n                        data.append(\"file\", file.blob, file.name)\r\n                    } else {\r\n                        data.append(\"file\", file, file.name)\r\n                    }\r\n                }\r\n            });\r\n            handleSendPhotos(data)\r\n\r\n            // let photosDeleting = photos.filter((item, key) => (item.blob && item.id))\r\n            // if(photosDeleting.length) {\r\n            //     Promise.all(photosDeleting.map(item => handleRemovePhoto(item.id)))\r\n            //         .then(res => {\r\n            //             handleSendPhotos(data)\r\n            //         })\r\n            // } else {\r\n            //     handleSendPhotos(data)\r\n            // }\r\n\r\n        } else if(step == 5) {\r\n            let filterV = videos.filter(item => !!item)\r\n            const res = await apiEditOffer(id, {step: 2, videoUrl: filterV})\r\n            setOffer({...offer, videoUrl: res.data.videoUrl})\r\n            Router.push('/offers/[id]/regulations', `/offers/${id}/regulations`, {shallow: true})\r\n        }\r\n    }\r\n\r\n    const handleSendPhotos = data => {\r\n        //TODO optimaze and don't send if something not changed\r\n\r\n        setLoading(true)\r\n        apiSetOfferCoverPhoto(id,{offerPhotoId: cover})\r\n            .then(res => {\r\n                debugger\r\n                setOffer({...offer, avatarUrl: res.data.avatarUrl})\r\n            })\r\n\r\n        let photosWithDesc = photos.filter(item => item.description)\r\n        Promise.all(photosWithDesc.map(item => handleEditPhoto(item)))\r\n            .then(res => {\r\n               console.log('res', res)\r\n            })\r\n\r\n        apiOfferPhotos(data)\r\n            .then(res => {\r\n                setLoading(false)\r\n                let photosFilter = photos.filter((item) => {\r\n                    return (item.id && !item.blob)\r\n                })\r\n                setPhotos([...photosFilter, ...res.data])\r\n                setOffer({...offer, offerPhoto: [...photosFilter, ...res.data]})\r\n                setStep(5)\r\n            })\r\n            .catch(e => {\r\n                showNotification('error', e)\r\n                setLoading(false)\r\n            })\r\n    }\r\n\r\n    const handleEditPhoto = async photo => {\r\n        const res = await apiEditOfferPhoto(photo)\r\n        console.log(res)\r\n        return res\r\n    }\r\n\r\n    const handleRemovePhoto = async id => {\r\n        const res = await apiRemoveOfferPhoto(id)\r\n        console.log(res)\r\n        return res\r\n    }\r\n\r\n    const handleDeletePhoto = async (key) => {\r\n        let photoByKey = photos[key];\r\n        if(photoByKey.id) {\r\n            const res = await handleRemovePhoto(photoByKey.id)\r\n            let photosClone = [...photos]\r\n            photosClone.splice(key, 1)\r\n            setPhotos(photosClone)\r\n            setStep(2)\r\n        } else {\r\n            let photosClone = [...photos]\r\n            photosClone.splice(key, 1)\r\n            setPhotos(photosClone)\r\n            setStep(2)\r\n        }\r\n    }\r\n\r\n    const setEditablePhoto = (photo, key) => {\r\n        setPhotoEditable(photo)\r\n        setKeyPhoto(key)\r\n        setStep(4)\r\n    }\r\n    const handleBackFromEdit = () => {\r\n        setPhotoEditable({})\r\n        setKeyPhoto(null)\r\n        setStep(2)\r\n    }\r\n    const handleRotate = async (blob, url, key) => {\r\n        try {\r\n            let photosCopy = [...photos],\r\n                ephoto = photosCopy[key],\r\n                isCover = !!(cover == ephoto.id)\r\n\r\n            setLoadingEdit(true)\r\n            let data = new FormData();\r\n            data.append(\"offerId\", offer.id);\r\n            data.append(\"file\", blob, 'blob file')\r\n            let res = await apiOfferPhotos(data)\r\n            if(ephoto && ephoto.id) {\r\n                await handleRemovePhoto(ephoto.id)\r\n            }\r\n            if(isCover) {\r\n                setCover(res.data[0].id)\r\n            }\r\n            photosCopy[key] = res.data[0]\r\n            setPhotos(photosCopy)\r\n            setLoadingEdit(false)\r\n            setStep(2)\r\n        }\r\n        catch (e) {\r\n            showNotification('error', e)\r\n            setLoadingEdit(false)\r\n        }\r\n\r\n    }\r\n\r\n    const onChangePhotoDescription = (id, value) => {\r\n        value = value.slice(0, 100)\r\n        let photosClone = [...photos]\r\n        let key = photosClone.findIndex(item => item.id === id)\r\n        photosClone[key].description = value\r\n        setPhotos(photosClone)\r\n        console.log(key, value)\r\n    }\r\n\r\n    const disabled = loading;\r\n\r\n    return (\r\n        <>\r\n            <Header isReg />\r\n            <Wrapper p={17} pt={35}>\r\n                {offer.id ?\r\n                    <>\r\n                    <ContainerDesktop isOffer>\r\n                        <WrapperHeight>\r\n                            {uploading && <div className='photo-uploading-router'> Uploading... </div>}\r\n\r\n                            {step === 1 && <Upload onDrop={onDrop} />}\r\n                            {step === 2 &&\r\n                                <Photos\r\n                                    onDrop={onDrop}\r\n                                    setStep={setStep}\r\n                                    cover={cover}\r\n                                    photos={photos}\r\n                                    setEditablePhoto={setEditablePhoto}\r\n                                    isHiddenDeleting={true}\r\n                                />\r\n                            }\r\n                            {step === 3 &&\r\n                                <CoverPhoto\r\n                                    photos={photos}\r\n                                    setCover={onSetCover}\r\n                                    handleBack={handleBackFromEdit}\r\n                                    cover={cover}\r\n                                />\r\n                            }\r\n                            {step === 4 &&\r\n                                <EditPhoto\r\n                                    keyPhoto={keyPhoto}\r\n                                    photo={photoEditable}\r\n                                    handleBack={handleBackFromEdit}\r\n                                    handleRotate={handleRotate}\r\n                                    handleDelete={handleDeletePhoto}\r\n                                    onChangePhotoDescription={onChangePhotoDescription}\r\n                                    loadingEdit={loadingEdit}\r\n                                />\r\n                            }\r\n                            {step === 5 && <Video videos={videos} setVideos={(videos) => setVideos([...videos])} />}\r\n                        </WrapperHeight>\r\n                    </ContainerDesktop>\r\n\r\n                        {step !== 3 && step !== 4 &&\r\n                        <FooterDesktop>\r\n                            <Footer pt={30} >\r\n                                <Button onClick={() => handleChangeStep(-1)}>Back</Button>\r\n                                <Button blue\r\n                                        onClick={() => handleSave()}\r\n                                        loading={loading}\r\n                                >\r\n                                    {step === 1 ? 'Skip' : 'Next'}\r\n                                </Button>\r\n                            </Footer>\r\n                        </FooterDesktop>\r\n                        }\r\n\r\n                    </>\r\n                    :\r\n                    <>Loading...</>\r\n                }\r\n\r\n\r\n            </Wrapper>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default PhotosPage\r\n\r\n"]},"metadata":{},"sourceType":"module"}